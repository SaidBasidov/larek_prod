(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const p of c.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&s(p)}).observe(document,{childList:!0,subtree:!0});function r(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function s(o){if(o.ep)return;o.ep=!0;const c=r(o);fetch(o.href,c)}})();class T{baseUrl;options;constructor(t,r={}){this.baseUrl=t,this.options={headers:{"Content-Type":"application/json",...r.headers??{}}}}handleResponse(t){return t.ok?t.json():t.json().then(r=>Promise.reject(r.error??t.statusText))}get(t){return fetch(this.baseUrl+t,{...this.options,method:"GET"}).then(this.handleResponse)}post(t,r,s="POST"){return fetch(this.baseUrl+t,{...this.options,method:s,body:JSON.stringify(r)}).then(this.handleResponse)}}class U{_events;constructor(){this._events=new Map}on(t,r){this._events.has(t)||this._events.set(t,new Set),this._events.get(t)?.add(r)}off(t,r){this._events.has(t)&&(this._events.get(t).delete(r),this._events.get(t)?.size===0&&this._events.delete(t))}emit(t,r){this._events.forEach((s,o)=>{o==="*"&&s.forEach(c=>c({eventName:t,data:r})),(o instanceof RegExp&&o.test(t)||o===t)&&s.forEach(c=>c(r))})}onAll(t){this.on("*",t)}offAll(){this._events=new Map}trigger(t,r){return(s={})=>{this.emit(t,{...s||{},...r||{}})}}}class ${api;constructor(t){this.api=t}async getProducts(){try{return(await this.api.get("/product/")).items}catch(t){throw console.log(`Error while loading ${t}`),t}}async postOrder(t){try{return await this.api.post("/order/",t)}catch(r){throw console.log("Error while uploading",r),r}}}const I="undefined/api/weblarek",_="undefined/content/weblarek",P={"софт-скил":"card__category_soft","хард-скил":"card__category_hard",кнопка:"card__category_button",дополнительное:"card__category_additional",другое:"card__category_other"};var n=(e=>(e.BasketOpen="BasketOpen",e.ModalClose="ModalClose",e.FormOrderCart="FormOrderCart",e.CatalogCardOpen="CatalogCardOpen",e.FormCardOpen="FormCardOpen",e.CardInfo="CardInfo",e.FormSubmit="FormSubmit",e.EmailInput="EmailInput",e.PhoneInput="PhoneInput",e.AddressInput="AddressInput",e.PaymentMethodSelected="PaymentMethodSelected",e.CloseModalSuccess="CloseModalSuccess",e.BuyerDataClear="BuyerDataClear",e.BuyerDataSet="BuyerDataSet",e.CartUpdate="CartUpdate",e.CatalogSetSelectedProduct="CatalogSetSelectedProduct",e.CatalogSetProductLis="CatalogSetProductLis",e.test="test",e.CartDeleteProduct="CartDeleteProduct",e.AddressFormSubmit="AddressFormSubmit",e))(n||{});class R{constructor(t){this.event=t,this.event=t}payment="";email="";phone="";address="";getData(){return{payment:this.payment,email:this.email,phone:this.phone,address:this.address}}clearData(){this.payment="",this.email="",this.phone="",this.address="",this.event.emit(n.BuyerDataClear)}setData(t){t.address!==void 0&&(this.address=t.address),t.payment!==void 0&&(this.payment=t.payment),t.email!==void 0&&(this.email=t.email),t.phone!==void 0&&(this.phone=t.phone),this.event.emit(n.BuyerDataSet)}validate(){const t={};return this.payment||(t.payment="Отсутствует payment"),this.email===""&&(t.email="Отсутствует email"),this.phone===""&&(t.phone="Отсутствует phone"),this.address===""&&(t.address="Отсутствует address"),Object.keys(t).length>0?t:null}}class j{constructor(t){this.event=t,this.event=t}cartProductList=[];getCartProductList(){return this.cartProductList}addProduct(t){this.cartProductList.push(t),this.event.emit(n.CartUpdate)}deleteProduct(t){const r=this.cartProductList.findIndex(s=>s.id===t.id);this.cartProductList.splice(r,1),this.event.emit(n.CartUpdate)}getProductListLength(){return this.cartProductList.length}getPriceSum(t){return t.reduce((r,s)=>s.price===null?r:r+s.price,0)}isProductInList(t){return this.cartProductList.some(r=>r.id===t.id)}clearCart(){this.cartProductList=[],this.event.emit(n.CartUpdate)}}class q{constructor(t){this.event=t,this.event=t}productList=[];selectedProduct=null;getSelectedProduct(){return this.selectedProduct}setSelectedProduct(t){t!==null&&(this.selectedProduct=t),this.event.emit(n.CatalogSetSelectedProduct)}getProductList(){return this.productList}setProductList(t){this.productList=t,this.event.emit(n.CatalogSetProductLis)}getProductByID(t){let r=t.toString();const s=this.productList.find(o=>o.id===r);if(!s)throw new Error(`Не найден продукт по ID - ${r}`);return s}}function b(e){return typeof e=="string"&&e.length>1}function L(e,t=document){if(b(e))return Array.from(t.querySelectorAll(e));if(e instanceof NodeList)return Array.from(e);if(Array.isArray(e))return e;throw new Error("Unknown selector element")}function i(e,t){if(b(e)){const r=L(e,t);if(r.length>1&&console.warn(`selector ${e} return more then one element`),r.length===0)throw new Error(`selector ${e} return nothing`);return r.pop()}if(e instanceof HTMLElement)return e;throw new Error("Unknown selector element")}function h(e){const t=i(e);if(!t.content.firstElementChild)throw new Error(`Template ${e} has no content`);return t.content.firstElementChild.cloneNode(!0)}class m{constructor(t){this.container=t}setImage(t,r,s){t&&(t.src=r,s&&(t.alt=s))}render(t){return Object.assign(this,t??{}),this.container}}class y extends m{titleElement;priceElement;constructor(t){super(t),this.titleElement=i(".card__title",this.container),this.priceElement=i(".card__price",this.container)}set title(t){this.titleElement.textContent=t}set price(t){this.priceElement.textContent=`${t} синапсов`}set priceElementText(t){this.priceElement.textContent=t}}class K extends y{categoryElement;imageElement;constructor(t,r){super(t),this.categoryElement=i(".card__category",this.container),this.imageElement=i(".card__image",this.container),this.container.addEventListener("click",r.onClick)}set image(t){this.setImage(this.imageElement,t)}set category(t){const s=P[t];this.categoryElement.className="card__category",this.categoryElement.classList.add(s)}}class N extends y{indexElement;deleteButtonElement;constructor(t,r){super(t),this.indexElement=i(".basket__item-index",this.container),this.deleteButtonElement=i(".basket__item-delete",this.container),this.deleteButtonElement.addEventListener("click",r.onClick)}set index(t){this.indexElement.textContent=`${t}`}}class G extends y{buttonElement;infoElement;categoryElement;imageElement;constructor(t,r){super(t),this.buttonElement=i(".card__button",this.container),this.infoElement=i(".card__text",this.container),this.categoryElement=i(".card__category",this.container),this.imageElement=i(".card__image",this.container),this.buttonElement.addEventListener("click",()=>{r.emit(n.CardInfo)})}set description(t){this.infoElement.textContent=t}set cardButton(t){this.buttonElement.textContent=t}set CardButtonAvailability(t){this.buttonElement.disabled=t}set image(t){this.setImage(this.imageElement,t)}set category(t){const s=P[t];this.categoryElement.className="card__category",this.categoryElement.classList.add(s)}}class H extends m{counterElement;cartButton;constructor(t,r){super(r),this.counterElement=i(".header__basket-counter",this.container),this.cartButton=i(".header__basket",this.container),this.cartButton.addEventListener("click",()=>{t.emit(n.BasketOpen)})}set productsInCart(t){this.counterElement.textContent=String(t)}}class z extends m{listElement;totalElement;orderButtonElement;constructor(t,r){super(t),this.listElement=i(".basket__list",this.container),this.totalElement=i(".basket__price",this.container),this.orderButtonElement=i(".basket__button",this.container),this.orderButtonElement.addEventListener("click",()=>{r.emit(n.FormOrderCart)}),this.orderButtonElement.disabled=!0}set cartProductList(t){this.listElement.replaceChildren(...t)}set cartProductsTotal(t){const r=t??0;this.totalElement.textContent=`${r} синапсов`}set cartOrderButtonAvailability(t){this.orderButtonElement.disabled=t}}class J extends m{constructor(t){super(t)}set products(t){this.container.replaceChildren(...t)}}class S extends m{submitElement;errElement;constructor(t){super(t),this.errElement=i(".form__errors",this.container),this.submitElement=i('button[type="submit"]',this.container)}set submitAvailable(t){this.submitElement.disabled=t}set errMessage(t){this.errElement.textContent=t}}class V extends S{emailElement;phoneElement;errorElement;constructor(t,r){super(t),this.errorElement=i(".form__errors",this.container),this.emailElement=i('input[name="email"]',this.container),this.phoneElement=i('input[name="phone"]',this.container),this.container.addEventListener("submit",s=>{r.emit(n.FormSubmit,s)}),this.emailElement.addEventListener("input",()=>{r.emit(n.EmailInput,{email:this.emailElement.value})}),this.phoneElement.addEventListener("input",()=>{r.emit(n.PhoneInput,{phone:this.phoneElement.value})})}set email(t){this.emailElement.value=t}set phone(t){this.phoneElement.value=t}set errMessage(t){this.errorElement.textContent=t}}class Q extends S{addressElement;paymentSelectorElement;errorElement;constructor(t,r){super(t),this.addressElement=i('input[name="address"]',this.container),this.paymentSelectorElement=L(".button_alt",this.container),this.errorElement=i(".form__errors",this.container),this.addressElement.addEventListener("input",()=>{r.emit(n.AddressInput,{address:this.addressElement.value})}),this.container.addEventListener("submit",s=>{r.emit(n.AddressFormSubmit,s)}),this.paymentSelectorElement.forEach(s=>{s.addEventListener("click",()=>{r.emit(n.PaymentMethodSelected,s)})})}set address(t){this.addressElement.value=t}set paymentMethod(t){this.paymentSelectorElement.forEach(r=>{r.classList.toggle("button_alt-active",r.name===t)})}set errMessage(t){this.errorElement.textContent=t}}class W extends m{textElement;constructor(t,r){super(t),this.textElement=i(".order-success__description",this.container),this.container.addEventListener("click",()=>{r.emit(n.CloseModalSuccess)})}set text(t){this.textElement.textContent=t}}class X extends m{closeModalButton;content;constructor(t,r){super(r),this.closeModalButton=i(".modal__close",this.container),this.content=i(".modal__content",this.container),this.closeModalButton.addEventListener("click",()=>{t.emit(n.ModalClose)}),this.container.addEventListener("click",s=>{s.target===s.currentTarget&&t.emit(n.ModalClose)})}openModal(t){this.content.replaceChildren(t),this.container.classList.add("modal_active")}closeModal(){this.content.replaceChildren(),this.container.classList.remove("modal_active")}}const C=i(document.querySelector(".page")),Y=i(C.querySelector(".header")),Z=i(C.querySelector(".gallery")),tt=i(C.querySelector(".modal")),et=new T(I),M=new $(et),a=new U,l=new j(a),d=new R(a),g=new q(a),rt=new H(a,Y),u=new X(a,tt),st=new J(Z),x=new G(h("#card-preview"),a),v=new z(h("#basket"),a),E=new Q(h("#order"),a),f=new V(h("#contacts"),a),nt=new W(h("#success"),a);M.getProducts().then(e=>{g.setProductList(e)}).catch(e=>console.log("Сouldn't load products",e));a.on(n.CatalogSetProductLis,()=>{const e=g.getProductList().map(t=>{const r=new K(h("#card-catalog"),{onClick:()=>a.emit(n.test,t)});let s;t.price==null||t.price===0?s="Бесценно":s=`${t.price} синапсов`;const o={...t,image:_+t.image,priceElementText:s};return a.on(n.CatalogCardOpen,()=>g.setSelectedProduct(t)),r.render(o)});st.products=e});a.on(n.test,e=>{const t=g.getProductByID(e.id);let r,s,o;t.price==null||t.price===0?(r="Недоступно",s="Бесценно",o=!0):l.getCartProductList().includes(t)?(r="Удалить из корзины",s=`${t.price} синапсов`,o=!1):(r="Купить",s=`${t.price} синапсов`,o=!1);const c={...t,image:_+t.image,cardButton:r,priceElementText:s,CardButtonAvailability:o};x.render(c),g.setSelectedProduct(t)});a.on(n.CatalogSetSelectedProduct,()=>{u.openModal(x.render())});a.on(n.ModalClose,()=>{u.closeModal()});a.on(n.CartUpdate,()=>{const e=l.getCartProductList(),t=l.getPriceSum(e),r=l.getProductListLength();let s=!0;r>0&&(s=!1),rt.render({productsInCart:r});const c={cartProductList:e.map((p,k)=>{const D=new N(h("#card-basket"),{onClick:()=>a.emit(n.CartDeleteProduct,p)}),F={...p,index:k+1};return D.render(F)}),cartProductsTotal:t,cartOrderButtonAvailability:s};v.render(c)});a.on(n.BasketOpen,()=>{u.openModal(v.render())});a.on(n.CardInfo,()=>{const e=g.getSelectedProduct();e&&(l.getCartProductList().includes(e)?l.deleteProduct(e):l.addProduct(e),u.closeModal())});a.on(n.CartDeleteProduct,e=>{l.deleteProduct(e)});a.on(n.FormOrderCart,()=>{u.openModal(E.render())});a.on(n.AddressInput,({address:e})=>{d.setData({address:e}),B()});a.on(n.PaymentMethodSelected,e=>{d.setData({payment:e.name}),B()});a.on(n.AddressFormSubmit,e=>{e.preventDefault(),u.openModal(f.render())});a.on(n.EmailInput,({email:e})=>{d.setData({email:e}),A()});a.on(n.PhoneInput,({phone:e})=>{d.setData({phone:e}),A()});const ot={payment:"Выберите способ оплаты",address:"Укажите адрес доставки",email:"Введите корректный email",phone:"Введите номер телефона"};function w(e,t){if(!e)return"";for(const r of t)if(e[r])return ot[r];return""}function B(){const e=w(d.validate(),["payment","address"]);E.errMessage=e,e===""?E.submitAvailable=!1:E.submitAvailable=!0}function A(){const e=w(d.validate(),["email","phone"]);f.errMessage=e,e===""?f.submitAvailable=!1:f.submitAvailable=!0}a.on(n.PaymentMethodSelected,e=>{const t=e.name;E.paymentMethod=t});function O(){return{...d.getData(),total:l.getPriceSum(l.getCartProductList()),items:l.getCartProductList().map(e=>e.id)}}async function it(){const e=O();try{const t=await M.postOrder(e);l.clearCart(),d.clearData(),u.openModal(nt.render({text:`Списано ${t.total} синапсов`}))}catch(t){console.log("Ошибка отправки формы на сервер",t)}}a.on(n.FormSubmit,e=>{e.preventDefault(),console.log(d.getData()),console.log(O()),u.closeModal(),it()});a.on(n.CloseModalSuccess,()=>{u.closeModal()});
